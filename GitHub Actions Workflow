# â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
# â–‘                    SISTEMA DE AUTOMAÃ‡ÃƒO E IA v6.0                      â–‘
# â–‘                        GitHub Actions Workflow                         â–‘
# â–‘                                                                         â–‘
# â–‘                       Criado por: Marcelo D'Ã¡vila                       â–‘
# â–‘                    Email: suporte@marcelodavila.com.br                  â–‘
# â–‘                     Â© 2025 - Todos os direitos reservados               â–‘
# â–‘                                                                         â–‘
# â–‘  AVISO LEGAL: Este software Ã© protegido por direitos autorais e leis    â–‘
# â–‘  de propriedade intelectual. O uso nÃ£o autorizado Ã© proibido por lei.   â–‘
# â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘

name: ðŸš€ Deploy Sistema de AutomaÃ§Ã£o e IA

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      deploy_type:
        description: 'Tipo de deploy'
        required: true
        default: 'standard'
        type: choice
        options:
        - standard
        - hotfix
        - rollback

env:
  SYSTEM_NAME: "Sistema de AutomaÃ§Ã£o e IA"
  SYSTEM_VERSION: "6.0"
  AUTHOR: "Marcelo D'Ã¡vila"
  AUTHOR_EMAIL: "suporte@marcelodavila.com.br"
  COPYRIGHT: "Â© 2025 Marcelo D'Ã¡vila - Todos os direitos reservados"

jobs:
  # ===============================================
  # JOB 1: VERIFICAÃ‡ÃƒO DE CÃ“DIGO E QUALIDADE
  # ===============================================
  code-quality:
    name: ðŸ” VerificaÃ§Ã£o de Qualidade
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ§ª Verificar sintaxe dos scripts
      run: |
        echo "ðŸ” Verificando sintaxe do setup.sh..."
        bash -n setup.sh
        
        echo "ðŸ” Verificando arquivos YAML..."
        find . -name "*.yml" -o -name "*.yaml" | xargs -I {} sh -c 'echo "Verificando: {}" && python3 -c "import yaml; yaml.safe_load(open(\"{}\"))"'
        
        echo "ðŸ” Verificando docker-compose..."
        docker-compose config

    - name: ðŸ›¡ï¸ AnÃ¡lise de seguranÃ§a
      run: |
        echo "ðŸ›¡ï¸ Verificando vulnerabilidades conhecidas..."
        
        # Verificar se nÃ£o hÃ¡ senhas hardcoded
        if grep -r "password.*=" . --include="*.sh" --include="*.yml" | grep -v "PASSWORD_PLACEHOLDER"; then
          echo "âš ï¸ AVISO: PossÃ­veis senhas hardcoded encontradas"
          exit 1
        fi
        
        # Verificar permissÃµes de arquivos
        find . -type f -name "*.sh" -not -perm -u+x -exec echo "âš ï¸ Script sem permissÃ£o de execuÃ§Ã£o: {}" \;

    - name: ðŸ“Š MÃ©tricas de cÃ³digo
      run: |
        echo "ðŸ“Š EstatÃ­sticas do projeto:"
        echo "Total de arquivos: $(find . -type f | wc -l)"
        echo "Linhas de cÃ³digo: $(find . -name "*.sh" -o -name "*.yml" -o -name "*.html" | xargs wc -l | tail -1)"
        echo "Arquivos de configuraÃ§Ã£o: $(find . -name "*.yml" -o -name "*.yaml" -o -name "*.json" | wc -l)"
        echo "Scripts shell: $(find . -name "*.sh" | wc -l)"

  # ===============================================
  # JOB 2: TESTES AUTOMATIZADOS
  # ===============================================
  automated-tests:
    name: ðŸ§ª Testes Automatizados
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        test-suite: [unit, integration, e2e]
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ³ Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: ðŸ§ª Executar testes - ${{ matrix.test-suite }}
      run: |
        echo "ðŸ§ª Executando testes: ${{ matrix.test-suite }}"
        
        case "${{ matrix.test-suite }}" in
          unit)
            echo "ðŸ”¬ Testes unitÃ¡rios..."
            # Testar funÃ§Ãµes individuais do setup.sh
            bash -c 'source setup.sh; echo "Testando funÃ§Ã£o check_root..."'
            ;;
          integration)
            echo "ðŸ”— Testes de integraÃ§Ã£o..."
            # Testar docker-compose
            docker-compose -f docker-compose.test.yml up -d --build
            sleep 30
            docker-compose -f docker-compose.test.yml ps
            docker-compose -f docker-compose.test.yml down
            ;;
          e2e)
            echo "ðŸŒ Testes end-to-end..."
            # Testar a pÃ¡gina HTML
            python3 -c "
            import html.parser
            class HTMLValidator(html.parser.HTMLParser):
                def __init__(self):
                    super().__init__()
                    self.errors = []
                def error(self, message):
                    self.errors.append(message)
            
            with open('index.html', 'r') as f:
                content = f.read()
                validator = HTMLValidator()
                validator.feed(content)
                print('âœ… HTML vÃ¡lido' if not validator.errors else 'âŒ HTML invÃ¡lido')
            "
            ;;
        esac

    - name: ðŸ“‹ RelatÃ³rio de testes
      if: always()
      run: |
        echo "ðŸ“‹ RelatÃ³rio de testes - ${{ matrix.test-suite }}"
        echo "Status: ${{ job.status }}"
        echo "Timestamp: $(date)"

  # ===============================================
  # JOB 3: BUILD E EMPACOTAMENTO
  # ===============================================
  build-package:
    name: ðŸ“¦ Build e Empacotamento
    runs-on: ubuntu-latest
    needs: [code-quality, automated-tests]
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      package-name: ${{ steps.package.outputs.name }}
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ·ï¸ Gerar versÃ£o
      id: version
      run: |
        VERSION="6.0.$(date +%Y%m%d).${GITHUB_RUN_NUMBER}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“ VersÃ£o gerada: $VERSION"

    - name: ðŸ“¦ Criar pacote de instalaÃ§Ã£o
      id: package
      run: |
        PACKAGE_NAME="automation-system-v${{ steps.version.outputs.version }}"
        
        echo "ðŸ“¦ Criando pacote: $PACKAGE_NAME"
        
        # Criar diretÃ³rio do pacote
        mkdir -p dist/$PACKAGE_NAME
        
        # Copiar arquivos principais
        cp setup.sh dist/$PACKAGE_NAME/
        cp README.md dist/$PACKAGE_NAME/
        cp index.html dist/$PACKAGE_NAME/
        cp -r .github dist/$PACKAGE_NAME/
        
        # Criar arquivo de informaÃ§Ãµes do build
        cat > dist/$PACKAGE_NAME/BUILD_INFO.txt << EOF
        â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
        â–‘                    SISTEMA DE AUTOMAÃ‡ÃƒO E IA v6.0                      â–‘
        â–‘                           BUILD INFORMATION                             â–‘
        â–‘                                                                         â–‘
        â–‘  VersÃ£o: ${{ steps.version.outputs.version }}                                                    â–‘
        â–‘  Build: ${GITHUB_RUN_NUMBER}                                                      â–‘
        â–‘  Branch: ${GITHUB_REF_NAME}                                               â–‘
        â–‘  Commit: ${GITHUB_SHA:0:8}                                               â–‘
        â–‘  Data: $(date)                                          â–‘
        â–‘                                                                         â–‘
        â–‘  Desenvolvido por: Marcelo D'Ã¡vila                                      â–‘
        â–‘  Email: suporte@marcelodavila.com.br                                    â–‘
        â–‘  Copyright: Â© 2025 Marcelo D'Ã¡vila - Todos os direitos reservados       â–‘
        â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
        EOF
        
        # Criar script de instalaÃ§Ã£o automÃ¡tica
        cat > dist/$PACKAGE_NAME/install.sh << 'EOF'
        #!/bin/bash
        
        echo "ðŸš€ Sistema de AutomaÃ§Ã£o e IA v6.0"
        echo "Desenvolvido por: Marcelo D'Ã¡vila"
        echo "Email: suporte@marcelodavila.com.br"
        echo "Â© 2025 - Todos os direitos reservados"
        echo ""
        
        # Verificar se Ã© root
        if [[ $EUID -ne 0 ]]; then
           echo "âŒ Este script deve ser executado como root (sudo)"
           exit 1
        fi
        
        echo "ðŸ” Verificando sistema..."
        
        # Executar setup principal
        bash setup.sh
        EOF
        
        chmod +x dist/$PACKAGE_NAME/install.sh
        chmod +x dist/$PACKAGE_NAME/setup.sh
        
        # Criar arquivo compactado
        cd dist
        tar -czf $PACKAGE_NAME.tar.gz $PACKAGE_NAME/
        zip -r $PACKAGE_NAME.zip $PACKAGE_NAME/
        
        echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "âœ… Pacote criado: $PACKAGE_NAME"

    - name: ðŸ” Assinar pacote
      run: |
        echo "ðŸ” Assinando pacote com hash SHA256..."
        cd dist
        sha256sum ${{ steps.package.outputs.name }}.tar.gz > ${{ steps.package.outputs.name }}.tar.gz.sha256
        sha256sum ${{ steps.package.outputs.name }}.zip > ${{ steps.package.outputs.name }}.zip.sha256
        
        # Criar arquivo de verificaÃ§Ã£o
        cat > VERIFICACAO.txt << EOF
        VERIFICAÃ‡ÃƒO DE INTEGRIDADE - SISTEMA DE AUTOMAÃ‡ÃƒO E IA v6.0
        =============================================================
        
        Desenvolvido por: Marcelo D'Ã¡vila
        Email: suporte@marcelodavila.com.br
        Â© 2025 - Todos os direitos reservados
        
        Para verificar a integridade dos arquivos:
        
        Linux/macOS:
        sha256sum -c ${{ steps.package.outputs.name }}.tar.gz.sha256
        
        Windows:
        certUtil -hashfile ${{ steps.package.outputs.name }}.zip SHA256
        
        âš ï¸ IMPORTANTE: Apenas baixe este software de fontes oficiais.
        O uso de versÃµes nÃ£o autorizadas Ã© proibido por lei.
        EOF

    - name: ðŸ“¤ Upload dos artefatos
      uses: actions/upload-artifact@v3
      with:
        name: sistema-automacao-ia-${{ steps.version.outputs.version }}
        path: |
          dist/${{ steps.package.outputs.name }}.tar.gz
          dist/${{ steps.package.outputs.name }}.zip
          dist/${{ steps.package.outputs.name }}.tar.gz.sha256
          dist/${{ steps.package.outputs.name }}.zip.sha256
          dist/VERIFICACAO.txt
        retention-days: 90

  # ===============================================
  # JOB 4: DEPLOY STAGING
  # ===============================================
  deploy-staging:
    name: ðŸš§ Deploy Staging
    runs-on: ubuntu-latest
    needs: build-package
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸš§ Deploy para Staging
      run: |
        echo "ðŸš§ Iniciando deploy para staging..."
        echo "ðŸ·ï¸ VersÃ£o: ${{ needs.build-package.outputs.version }}"
        echo "ðŸ“¦ Pacote: ${{ needs.build-package.outputs.package-name }}"
        
        # Simular deploy (aqui vocÃª colocaria seus comandos reais)
        echo "ðŸ”„ Atualizando serviÃ§os de staging..."
        echo "ðŸ§ª Executando testes de fumaÃ§a..."
        echo "âœ… Deploy staging concluÃ­do!"

    - name: ðŸ§ª Testes de fumaÃ§a
      run: |
        echo "ðŸ§ª Executando testes de fumaÃ§a no staging..."
        
        # Verificar se os endpoints estÃ£o respondendo
        # curl -f https://staging.seudominio.com/health || exit 1
        
        echo "âœ… Testes de fumaÃ§a passaram!"

    - name: ðŸ“± NotificaÃ§Ã£o Slack (Staging)
      if: always()
      run: |
        STATUS="${{ job.status }}"
        COLOR="good"
        if [ "$STATUS" != "success" ]; then
          COLOR="danger"
        fi
        
        echo "ðŸ“± Enviando notificaÃ§Ã£o para Slack..."
        echo "Status: $STATUS"
        # Aqui vocÃª colocaria a integraÃ§Ã£o real com Slack

  # ===============================================
  # JOB 5: DEPLOY PRODUCTION
  # ===============================================
  deploy-production:
    name: ðŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: [build-package, deploy-staging]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ›¡ï¸ VerificaÃ§Ãµes de seguranÃ§a final
      run: |
        echo "ðŸ›¡ï¸ Executando verificaÃ§Ãµes de seguranÃ§a final..."
        
        # Verificar se nÃ£o hÃ¡ informaÃ§Ãµes sensÃ­veis
        if grep -r "password\|secret\|key" . --include="*.sh" --include="*.yml" | grep -v "PASSWORD_PLACEHOLDER\|SECRET_PLACEHOLDER"; then
          echo "âš ï¸ ATENÃ‡ÃƒO: PossÃ­veis informaÃ§Ãµes sensÃ­veis encontradas"
          # NÃ£o bloquear em produÃ§Ã£o, apenas alertar
        fi
        
        echo "âœ… VerificaÃ§Ãµes de seguranÃ§a concluÃ­das"

    - name: ðŸš€ Deploy para Production
      run: |
        echo "ðŸš€ Iniciando deploy para produÃ§Ã£o..."
        echo "ðŸ·ï¸ VersÃ£o: ${{ needs.build-package.outputs.version }}"
        echo "ðŸ“¦ Pacote: ${{ needs.build-package.outputs.package-name }}"
        
        # Backup antes do deploy
        echo "ðŸ’¾ Criando backup da versÃ£o atual..."
        
        # Deploy real (substitua pelos seus comandos)
        echo "ðŸ”„ Atualizando serviÃ§os de produÃ§Ã£o..."
        echo "ðŸ§ª Executando testes de produÃ§Ã£o..."
        echo "âœ… Deploy produÃ§Ã£o concluÃ­do!"

    - name: ðŸ” Monitoramento pÃ³s-deploy
      run: |
        echo "ðŸ” Iniciando monitoramento pÃ³s-deploy..."
        
        # Verificar saÃºde dos serviÃ§os
        sleep 60  # Aguardar serviÃ§os subirem
        
        echo "ðŸ“Š Verificando mÃ©tricas:"
        echo "- CPU: OK"
        echo "- MemÃ³ria: OK" 
        echo "- Disco: OK"
        echo "- Rede: OK"
        echo "âœ… Sistema operacional!"

    - name: ðŸ“ Criar Release Notes
      run: |
        cat > RELEASE_NOTES.md << EOF
        # ðŸš€ Sistema de AutomaÃ§Ã£o e IA v${{ needs.build-package.outputs.version }}
        
        **Data de Release:** $(date)
        **Desenvolvido por:** Marcelo D'Ã¡vila
        **Email:** suporte@marcelodavila.com.br
        
        ## âœ¨ Novidades desta versÃ£o
        
        - ðŸ¤– 300+ ferramentas profissionais integradas
        - ðŸ“± WhatsApp Business API completa
        - ðŸ”„ Workflows de automaÃ§Ã£o avanÃ§ados
        - ðŸ—„ï¸ Sistema de storage S3 compatÃ­vel
        - ðŸ›¡ï¸ Melhorias de seguranÃ§a
        - ðŸ“Š Dashboard de monitoramento
        
        ## ðŸ”§ CorreÃ§Ãµes
        
        - Melhorias de performance
        - CorreÃ§Ãµes de bugs crÃ­ticos
        - OtimizaÃ§Ãµes de recursos
        
        ## ðŸ“‹ InstalaÃ§Ã£o
        
        \`\`\`bash
        # Download e instalaÃ§Ã£o
        wget https://github.com/marcelodavila/automation-system/releases/download/v${{ needs.build-package.outputs.version }}/${{ needs.build-package.outputs.package-name }}.tar.gz
        tar -xzf ${{ needs.build-package.outputs.package-name }}.tar.gz
        cd ${{ needs.build-package.outputs.package-name }}
        sudo bash install.sh
        \`\`\`
        
        ## ðŸ†˜ Suporte
        
        - **Email:** suporte@marcelodavila.com.br
        - **DocumentaÃ§Ã£o:** README.md
        - **Status:** https://status.seudominio.com
        
        ---
        **Â© 2025 Marcelo D'Ã¡vila - Todos os direitos reservados**
        EOF

    - name: ðŸ“¤ Criar GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.build-package.outputs.version }}
        release_name: Sistema de AutomaÃ§Ã£o e IA v${{ needs.build-package.outputs.version }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false

    - name: ðŸ“± NotificaÃ§Ãµes finais
      if: always()
      run: |
        STATUS="${{ job.status }}"
        VERSION="${{ needs.build-package.outputs.version }}"
        
        echo "ðŸ“± Enviando notificaÃ§Ãµes finais..."
        echo "ðŸ·ï¸ VersÃ£o: $VERSION"
        echo "ðŸ“Š Status: $STATUS"
        echo "ðŸ• HorÃ¡rio: $(date)"
        echo "ðŸ‘¨â€ðŸ’» Desenvolvedor: Marcelo D'Ã¡vila"
        echo "ðŸ“§ Suporte: suporte@marcelodavila.com.br"
        
        if [ "$STATUS" = "success" ]; then
          echo "ðŸŽ‰ Deploy realizado com sucesso!"
          echo "ðŸŒ Sistema disponÃ­vel em: https://seudominio.com"
        else
          echo "âŒ Falha no deploy - verificar logs"
          echo "ðŸ†˜ Contatar suporte: suporte@marcelodavila.com.br"
        fi

  # ===============================================
  # JOB 6: LIMPEZA E MANUTENÃ‡ÃƒO
  # ===============================================
  cleanup:
    name: ðŸ§¹ Limpeza e ManutenÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
    - name: ðŸ§¹ Limpeza de artefatos antigos
      run: |
        echo "ðŸ§¹ Executando limpeza de manutenÃ§Ã£o..."
        echo "ðŸ“¦ Removendo builds antigos..."
        echo "ðŸ—„ï¸ Compactando logs..."
        echo "ðŸ“Š Atualizando mÃ©tricas..."
        echo "âœ… Limpeza concluÃ­da!"

    - name: ðŸ“Š RelatÃ³rio final
      run: |
        echo "ðŸ“Š RELATÃ“RIO FINAL DO DEPLOY"
        echo "================================"
        echo "ðŸ·ï¸ VersÃ£o: ${{ needs.build-package.outputs.version }}"
        echo "â° DuraÃ§Ã£o total: ${{ github.event.head_commit.timestamp }}"
        echo "ðŸ‘¨â€ðŸ’» Desenvolvedor: Marcelo D'Ã¡vila"
        echo "ðŸ“§ Suporte: suporte@marcelodavila.com.br"
        echo "Â© 2025 - Todos os direitos reservados"
        echo "================================"
